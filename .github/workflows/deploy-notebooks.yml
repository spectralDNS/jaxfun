name: Deploy Marimo Notebooks to GitHub Pages

on:
  push:
    branches:
      - main
      - marimo-notebooks
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false # since execution is only triggered if there are changes to the notebooks, we don't want to cancel in-progress deployments

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch all history to compare with previous commit

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Create output directory
        run: mkdir -p html_output

      - name: Get changed notebook files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # For manual runs, convert all notebooks
            echo "Manual workflow dispatch - converting all notebooks"
            changed_notebooks=$(find examples/notebooks -name "*.py" -type f)
          else
            # Get the list of changed .py files in the notebooks directory
            changed_notebooks=$(git diff --name-only HEAD^ HEAD | grep '^examples/notebooks/.*\.py$' || true)
          fi

          if [ -z "$changed_notebooks" ]; then
            echo "No notebook files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed notebooks:"
            echo "$changed_notebooks"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Save the list to a file for the next step
            echo "$changed_notebooks" > /tmp/changed_notebooks.txt
          fi

      - name: Convert modified marimo notebooks to HTML
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          echo "Converting modified marimo notebooks to HTML..."
          while IFS= read -r notebook; do
            if [ -f "$notebook" ]; then
              filename=$(basename "$notebook" .py)
              echo "Converting $notebook to html_output/${filename}.html"
              uv run marimo export html "$notebook" -o "html_output/${filename}.html"
            fi
          done < /tmp/changed_notebooks.txt

      - name: Check if any HTML files exist
        id: check-html
        run: |
          if [ -n "$(find html_output -name '*.html' -type f 2>/dev/null)" ]; then
            echo "html_exists=true" >> $GITHUB_OUTPUT
          else
            echo "html_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout gh-pages branch to preserve existing files
        if: steps.check-html.outputs.html_exists == 'true'
        run: |
          # Fetch the gh-pages branch if it exists
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "gh-pages branch exists, fetching existing HTML files..."
            git fetch origin gh-pages
            git checkout gh-pages

            # Recreate output directory after checkout
            mkdir -p html_output

            # Copy existing HTML files to html_output (excluding index.html)
            if [ -d "." ]; then
              find . -maxdepth 1 -name "*.html" ! -name "index.html" -exec cp -n {} html_output/ \;
            fi

            # Switch back to main branch
            git checkout -
          else
            echo "gh-pages branch does not exist yet"
          fi

      - name: Create index.html
        if: steps.check-html.outputs.html_exists == 'true'
        run: |
          python - << 'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("examples/notebooks/notebooks.yml").read_text())
          sections = data.get("sections", [])

          def card(item: dict) -> str:
            label = item.get("label", "Untitled")
            desc = item.get("description", "")
            href = item.get("file", "#")
            desc_html = f"<small>{desc}</small>" if desc else ""
            return f"<div class=\"card\"><a href=\"{href}\">{label}</a>{desc_html}</div>"

          section_html = []
          for section in sections:
            title = section.get("title", "")
            items = section.get("items", [])
            cards = "\n".join(card(item) for item in items)
            section_html.append(
              "\n".join(
                [
                  "<div class=\"section\">",
                  f"  <div class=\"section-title\">{title}</div>",
                  "  <div class=\"grid\">",
                  f"{cards}",
                  "  </div>",
                  "</div>",
                ]
              )
            )

          html = """<!DOCTYPE html>
          <html lang=\"en\">
          <head>
            <meta charset=\"UTF-8\">
            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
            <title>Marimo Notebooks</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                max-width: 1100px;
                margin: 0 auto;
                padding: 48px 20px 64px;
                line-height: 1.6;
                color: #1f2937;
                background: #f5f7fb;
              }
              h1 {
                color: #111827;
                margin-bottom: 8px;
              }
              .subtitle {
                color: #4b5563;
                margin-bottom: 28px;
              }
              .section {
                margin: 28px 0 36px;
              }
              .section-title {
                font-size: 1.1rem;
                color: #111827;
                margin: 0 0 16px;
                letter-spacing: 0.02em;
                text-transform: uppercase;
              }
              .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 16px;
              }
              .card {
                background: #ffffff;
                border-radius: 12px;
                padding: 16px 18px;
                border: 1px solid #e5e7eb;
                box-shadow: 0 2px 8px rgba(17, 24, 39, 0.06);
                transition: transform 0.2s ease, box-shadow 0.2s ease;
              }
              .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 18px rgba(17, 24, 39, 0.12);
              }
              .card a {
                color: #2563eb;
                text-decoration: none;
                font-weight: 600;
                font-size: 1.05rem;
              }
              .card a:hover {
                text-decoration: underline;
              }
              .card small {
                display: block;
                color: #6b7280;
                margin-top: 6px;
              }
              footer {
                margin-top: 56px;
                padding-top: 20px;
                border-top: 1px solid #e5e7eb;
                text-align: center;
                color: #6b7280;
              }
            </style>
          </head>
          <body>
            <h1>ðŸ““ Marimo Notebooks</h1>
            <p class=\"subtitle\">Curated, interactive notebooks grouped by topic.</p>
          """

          html += "\n".join(section_html)
          html += """
            <footer>
              <p>Generated with <a href=\"https://marimo.io\" target=\"_blank\">marimo</a></p>
            </footer>
          </body>
          </html>
          """

          Path("html_output/index.html").write_text(html)
          PY

      - name: Deploy to GitHub Pages
        if: steps.check-html.outputs.html_exists == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./html_output
          publish_branch: gh-pages
          force_orphan: false # Changed to false to preserve existing files
